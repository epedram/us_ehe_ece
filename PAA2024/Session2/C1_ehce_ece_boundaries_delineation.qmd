---
title: "PAA2024 - Extreme Heat and Cold Events Exposure Assessment with GridEX"
subtitle: "Exploring the aggregate impacts of extreme events"
author: "Pedram Fard"

format: html
editor: visual
---

## PAA2024 - Extreme Heat and Cold Events (EHE/ECE) Exposure Assessment with GridEX

April 2024, PAA Annual Meeting

### Session 2C - Exploring the impacts of extreme events within administrative boundaries

Author: Pedram Fard, Researcher at Harvard Medical School\
email: pedram_fard\@hms.harvard.edu

In this notebook we explore techniques to summarize the extreme events characteristics including event intensity and spatial extent. We'll focus on extracting values from grid layers overlapping different vector layers representing administrative boundaries.

```{r, message=TRUE, warning=FALSE, error=TRUE}
library(terra)
library(sf)

#workshop_dataset <- "../Data"
# Check out the data folders for today workshop
#list.files(workshop_dataset, full.names = TRUE)

# Load the spatial layers of administrative boundaries 
census_data_dir <- "../Data/Census_admin_boundaries"

us_states <- st_read(file.path(census_data_dir, "tigris_states_geo_CRS5070.gpkg"))
us_counties <- st_read(file.path(census_data_dir, "tigris_counties_geo_CRS5070.gpkg"))

daily_data_dir <- "../Data/GridEX_T002_daily_raster_dataset"
list.files(daily_data_dir, pattern = "idw")
```

```{r}
ehce_daily_raster_22Jan03 <- rast(file.path(daily_data_dir, "D2022-01-03_S526_T002_idw_ehce_grid.tif"))

plot(ehce_daily_raster_22Jan03)
plot(us_states[2], add = T, col = NA) 
```

## Dissolving the events intensity surfaces

```{r}
ece_daily_raster_22Jan03 <- rast(file.path(daily_data_dir, "D2022-01-03_S422_T002_idw_ece_dissolved_grid.tif"))
plot(ece_daily_raster_22Jan03, col = "blue")
plot(us_states[2], add = T, col = NA)
```

## Identifying events boundaries

```{r}
daily_vectors_dir <- "../Data/GridEX_S123_T002_daily_vector_dataset_GPKG"
list.files(daily_vectors_dir, "vector_boundaries")

```

```{r}
ehe_ece_boundaries_2022 <- st_read(file.path(daily_vectors_dir, "Y2022_S400_T002_ehe_ece_vector_boundaries_CRS5070.gpkg"))

#print(ehe_ece_boundaries_2022)
#View(ehe_ece_boundaries_2022)

#head(ehe_ece_boundaries_2022)
ls(ehe_ece_boundaries_2022)
```

```{r}
ehe_ece_boundaries_2022_01_03 <- ehe_ece_boundaries_2022 %>% 
  dplyr::filter(event_date == "2022-01-03")

plot(ece_daily_raster_22Jan03, col = "blue")
plot(ehe_ece_boundaries_2022_01_03["area_hectare"], col = NA, add = T)

#plot(ehce_daily_raster_22Jan03)
#plot(ehe_ece_boundaries_2022_01_03["area_hectare"], col = NA, add = T)
```

## 

```{r}
plot(ehce_daily_raster_22Jan03)
plot(ehe_ece_boundaries_2022_01_03["area_hectare"], col = NA, add = T)
```

## Overlay EHE/ECE with administrative boundaries

```{r}
plot(ehce_daily_raster_22Jan03)
#plot(ehe_ece_boundaries_2022_01_03["area_hectare"], col = NA)
plot(us_counties[2], col = NA, add = T)

#plot(us_counties[2], col = NA)
#plot(us_states[2], add = T, col = NA)
```

```{r}
impacted_areas_CA_2022 <- st_read(file.path(daily_vectors_dir, "Y2022_S190_T002_impacted_area_variables_intensity_Counties_wideformat_CRS4269_CA.gpkg"))

head(impacted_areas_CA_2022)
#View(impacted_areas_CA_2022)

length(unique(impacted_areas_CA_2022$event_date))

impacted_areas_CA_2022_01_03 <- impacted_areas_CA_2022 %>% 
  dplyr::filter(event_date == "2022-01-03")

ls(impacted_areas_CA_2022_01_03)
plot(impacted_areas_CA_2022["ehcmi_normalized_median_intensity"])
```

-   When analyzing the daily impacts data particularly for extended durations, it is recommended to work with tabular data. After performing your analysis you can then join the final results to the associated geometries.

```{r}
list.files(daily_vectors_dir)

C15_counties_impacted_areas <- readRDS(file.path(daily_vectors_dir, "C15_S190_T002_impacted_vars_intensity_Counties_TB.rds"))

head(C15_counties_impacted_areas)
```

## GridEX Shiny app demo

https://ehce.connect.hms.harvard.edu/us_ehe_ece/

I)  Explore extreme events dynamics and aggregate impacts
II) Explore extreme events aggregate impacts
